<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Farm Direct</title>
    <link rel="icon" type="image/png" href="images/brand.png?v=5">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css?v=2">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-left: 4px solid #28a745;
        }

        .stat-card.revenue {
            border-left-color: #007bff;
        }

        .stat-card.pending {
            border-left-color: #fd7e14;
        }

        .stat-card.completed {
            border-left-color: #28a745;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin: 0.5rem 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #f8f9fa;
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #eee;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-farmer {
            background: #d4edda;
            color: #155724;
        }

        .badge-customer {
            background: #cfe2ff;
            color: #084298;
        }

        .badge-admin {
            background: #e7d4f5;
            color: #5a21b5;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #eee;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #28a745;
            border-bottom-color: #28a745;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <div id="navbar-container"></div>

    <div class="container">
        <h2>Admin Dashboard</h2>

        <!-- Key Metrics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Users</div>
                <div class="stat-number" id="total-users">0</div>
                <small style="color: #999;">Farmers + Customers</small>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Orders</div>
                <div class="stat-number" id="total-orders">0</div>
                <small style="color: #999;">All orders</small>
            </div>
            <div class="stat-card revenue">
                <div class="stat-label">Total Revenue</div>
                <div class="stat-number" id="total-revenue">₹0</div>
                <small style="color: #999;">From all orders</small>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Products</div>
                <div class="stat-number" id="total-products">0</div>
                <small style="color: #999;">Listed products</small>
            </div>
            <div class="stat-card pending">
                <div class="stat-label">Pending Orders</div>
                <div class="stat-number" id="pending-orders">0</div>
                <small style="color: #999;">Awaiting delivery</small>
            </div>
            <div class="stat-card completed">
                <div class="stat-label">Completed Orders</div>
                <div class="stat-number" id="completed-orders">0</div>
                <small style="color: #999;">Delivered</small>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid-2">
            <div class="chart-container">
                <h3 style="margin-bottom: 1rem;">User Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="userChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h3 style="margin-bottom: 1rem;">Order Status Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="orderChart"></canvas>
                </div>
            </div>
        </div>

        <div class="chart-container" style="grid-column: 1/-1;">
            <h3 style="margin-bottom: 1rem;">Product Status</h3>
            <div class="chart-wrapper" style="height: 300px;">
                <canvas id="productChart"></canvas>
            </div>
        </div>

        <!-- Tables Section -->
        <h3 style="margin-top: 3rem;">Monitoring</h3>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('topProducts')">Top Products</button>
            <button class="tab-btn" onclick="switchTab('topFarmers')">Top Farmers</button>
            <button class="tab-btn" onclick="switchTab('recentOrders')">Recent Orders</button>
            <button class="tab-btn" onclick="switchTab('allUsers')">All Users</button>
        </div>

        <!-- Top Products Tab -->
        <div id="topProducts" class="tab-content active">
            <div class="table-container">
                <h4 style="margin-bottom: 1rem;">Top 5 Products by Orders</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Number of Orders</th>
                        </tr>
                    </thead>
                    <tbody id="topProductsBody">
                        <tr>
                            <td colspan="2" style="text-align: center; color: #999;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Farmers Tab -->
        <div id="topFarmers" class="tab-content">
            <div class="table-container">
                <h4 style="margin-bottom: 1rem;">Top 5 Farmers by Rating</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Farmer Name</th>
                            <th>Rating</th>
                            <th>Orders Fulfilled</th>
                        </tr>
                    </thead>
                    <tbody id="topFarmersBody">
                        <tr>
                            <td colspan="3" style="text-align: center; color: #999;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Orders Tab -->
        <div id="recentOrders" class="tab-content">
            <div class="table-container">
                <h4 style="margin-bottom: 1rem;">Recent Orders (Last 10)</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="recentOrdersBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- All Users Tab -->
        <div id="allUsers" class="tab-content">
            <div class="table-container">
                <h4 style="margin-bottom: 1rem;">All Users</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Rating</th>
                        </tr>
                    </thead>
                    <tbody id="allUsersBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/nav.js"></script>
    <script>
        let userChart, orderChart, productChart;

        async function loadDashboard() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || user.role !== 'ADMIN') {
                window.location.href = 'login.html';
                return;
            }

            try {
                const res = await fetch('/api/admin/dashboard');
                const data = await res.json();

                // Update stat cards
                document.getElementById('total-users').textContent = data.totalUsers;
                document.getElementById('total-orders').textContent = data.totalOrders;
                document.getElementById('total-revenue').textContent = '₹' + (data.totalRevenue || 0).toLocaleString('en-IN', { maximumFractionDigits: 2 });
                document.getElementById('total-products').textContent = data.totalProducts;
                document.getElementById('pending-orders').textContent = data.pendingOrders;
                document.getElementById('completed-orders').textContent = data.completedOrders;

                // Load user data
                loadUserStats(data.totalFarmers, data.totalCustomers);

                // Load order data
                loadOrderStats(data.pendingOrders, data.completedOrders);

                // Load product data
                loadProductStats();

                // Load tables
                if (data.topProducts) {
                    loadTopProducts(data.topProducts);
                }
                if (data.topFarmers) {
                    loadTopFarmers(data.topFarmers);
                }
                if (data.recentOrders) {
                    loadRecentOrders(data.recentOrders);
                }

                loadAllUsers();
            } catch (e) {
                console.error(e);
            }
        }

        function loadUserStats(farmers, customers) {
            const ctx = document.getElementById('userChart').getContext('2d');
            if (userChart) userChart.destroy();
            userChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Farmers', 'Customers'],
                    datasets: [{
                        data: [farmers, customers],
                        backgroundColor: ['#28a745', '#007bff'],
                        borderColor: white,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function loadOrderStats(pending, completed) {
            const ctx = document.getElementById('orderChart').getContext('2d');
            if (orderChart) orderChart.destroy();
            orderChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Completed'],
                    datasets: [{
                        data: [pending, completed],
                        backgroundColor: ['#fd7e14', '#28a745'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        async function loadProductStats() {
            try {
                const res = await fetch('/api/admin/stats/products');
                const stats = await res.json();

                const ctx = document.getElementById('productChart').getContext('2d');
                if (productChart) productChart.destroy();
                productChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Active', 'Paused', 'Out of Stock'],
                        datasets: [{
                            label: 'Product Count',
                            data: [stats.active, stats.paused, stats.outOfStock],
                            backgroundColor: ['#28a745', '#fd7e14', '#dc3545'],
                            borderColor: ['#28a745', '#fd7e14', '#dc3545'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'x',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            } catch (e) {
                console.error(e);
            }
        }

        function loadTopProducts(products) {
            const tbody = document.getElementById('topProductsBody');
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td>${p.productName}</td>
                    <td>${p.orderCount}</td>
                </tr>
            `).join('') || '<tr><td colspan="2" style="text-align: center; color: #999;">No data</td></tr>';
        }

        function loadTopFarmers(farmers) {
            const tbody = document.getElementById('topFarmersBody');
            tbody.innerHTML = farmers.map(f => `
                <tr>
                    <td>${f.farmerName}</td>
                    <td>
                        <span style="color: #fd7e14; font-weight: 600;">
                            ${'★'.repeat(Math.floor(f.rating))}${'☆'.repeat(5 - Math.floor(f.rating))}
                        </span>
                        <span style="margin-left: 0.5rem; color: #666;">${f.rating.toFixed(1)}</span>
                    </td>
                    <td>${f.orderCount}</td>
                </tr>
            `).join('') || '<tr><td colspan="3" style="text-align: center; color: #999;">No data</td></tr>';
        }

        function loadRecentOrders(orders) {
            const tbody = document.getElementById('recentOrdersBody');
            tbody.innerHTML = orders.map(o => `
                <tr>
                    <td>#${o.orderId}</td>
                    <td>${o.customerName}</td>
                    <td>₹${o.totalAmount.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
                    <td><span class="badge" style="background: #cfe2ff; color: #084298;">${o.status.replace(/_/g, ' ')}</span></td>
                    <td>${new Date(o.createdAt).toLocaleDateString('en-IN')}</td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align: center; color: #999;">No data</td></tr>';
        }

        async function loadAllUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const users = await res.json();

                const tbody = document.getElementById('allUsersBody');
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td><span class="badge badge-${u.role.toLowerCase()}">${u.role}</span></td>
                        <td>
                            <span style="color: #fd7e14; font-weight: 600;">
                                ${'★'.repeat(Math.floor(u.rating))}${'☆'.repeat(5 - Math.floor(u.rating))}
                            </span>
                            <span style="margin-left: 0.5rem; color: #666;">${u.rating.toFixed(1)}</span>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4" style="text-align: center; color: #999;">No users</td></tr>';
            } catch (e) {
                console.error(e);
            }
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>

</html>
