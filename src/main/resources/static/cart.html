<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cart - Farm Direct</title>
    <link rel="stylesheet" href="css/style.css?v=2">
    <link rel="icon" type="image/png" href="images/brand.png?v=5">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <div id="navbar-container"></div>

    <div class="container">
        <h2>My Cart</h2>

        <div id="cart-items"
            style="background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 1rem; margin-top: 1rem;">
            <!-- Cart items loaded here -->
            <p>Loading cart...</p>
        </div>

        <div style="margin-top: 2rem; text-align: right;">
            <button onclick="window.location.href='checkout.html'" id="checkout-btn" class="btn-primary"
                style="display: none; width: auto; padding: 1rem 3rem;">Proceed to Checkout</button>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/nav.js"></script>
    <script>
        let categoryMap = {}; // name -> unit

        async function loadCategories() {
            try {
                const res = await fetch('/api/categories');
                const categories = await res.json();
                categories.forEach(c => categoryMap[c.name] = c.unit);
            } catch (e) { console.error(e); }
        }

        async function loadCart() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) { window.location.href = 'login.html'; return; }

            // Ensure categories map is loaded first
            if (Object.keys(categoryMap).length === 0) await loadCategories();

            try {
                const res = await fetch(`/api/cart/${user.id}`);
                const items = await res.json();

                const container = document.getElementById('cart-items');
                if (items.length === 0) {
                    container.innerHTML = '<p>Your cart is empty.</p>';
                    document.getElementById('checkout-btn').style.display = 'none';
                    return;
                }

                let total = 0;
                let hasOutOfStock = false;
                container.innerHTML = items.map(item => {
                    const lineTotal = item.product.price * item.quantity;
                    total += lineTotal;
                    const unit = categoryMap[item.product.category] || '';
                    const isOutOfStock = item.product.status === 'OUT_OF_STOCK';
                    if (isOutOfStock) hasOutOfStock = true;
                    
                    const statusColor = item.product.status === 'OUT_OF_STOCK' ? '#dc3545' : item.product.status === 'PAUSED' ? '#fd7e14' : '#198754';
                    const statusText = item.product.status === 'OUT_OF_STOCK' ? 'OUT OF STOCK' : item.product.status === 'PAUSED' ? 'PAUSED' : 'ACTIVE';
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 1rem 0; opacity: ${isOutOfStock ? '0.6' : '1'};">
                            <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
                                <img src="${item.product.imageUrl || 'https://placehold.co/100x100'}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${item.product.name}</div>
                                    <div style="font-size: 0.8rem; color: ${statusColor}; font-weight: 600; margin-top: 4px;">${statusText}</div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 5px;">
                                        <button onclick="updateCartQty(${item.id}, ${item.quantity - 1})" 
                                            style="background: #e9ecef; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer;" ${isOutOfStock ? 'disabled' : ''}>-</button>
                                        <span style="font-size: 0.9rem; color: #666; min-width: 20px; text-align: center;">${item.quantity} ${unit}</span>
                                        <button onclick="updateCartQty(${item.id}, ${item.quantity + 1})" 
                                            style="background: #e9ecef; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer;" ${isOutOfStock ? 'disabled' : ''}>+</button>
                                        <span style="font-size: 0.8rem; color: #666; margin-left: 5px;">x ₹${item.product.price} / ${unit}</span>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700;">₹${lineTotal.toFixed(2)}</div>
                                <button onclick="removeItem(${item.id})" style="color: red; background: none; border: none; cursor: pointer; font-size: 0.8rem;">Remove</button>
                            </div>
                        </div>
                    `;
                }).join('') + `
                    <div style="margin-top: 1rem; text-align: right; font-size: 1.25rem; font-weight: 700;">
                        Total: ₹${total.toFixed(2)}
                    </div>
                    ${hasOutOfStock ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24; font-size: 0.9rem;">
                            <strong>⚠️ Cannot Checkout:</strong> Some items in your cart are out of stock. Please remove them to proceed with checkout.
                        </div>
                    ` : ''}
                `;

                const checkoutBtn = document.getElementById('checkout-btn');
                checkoutBtn.style.display = 'inline-block';
                checkoutBtn.disabled = hasOutOfStock;
                if (hasOutOfStock) {
                    checkoutBtn.style.opacity = '0.5';
                    checkoutBtn.style.cursor = 'not-allowed';
                } else {
                    checkoutBtn.style.opacity = '1';
                    checkoutBtn.style.cursor = 'pointer';
                }
            } catch (e) { console.error(e); }
        }

        async function updateCartQty(cartItemId, newQty) {
            if (newQty <= 0) {
                removeItem(cartItemId);
            } else {
                try {
                    const res = await fetch('/api/cart/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cartItemId: cartItemId, quantity: newQty })
                    });
                    if (res.ok) {
                        loadCart();
                    }
                } catch (e) { console.error(e); }
            }
        }

        async function removeItem(id) {
            try {
                await fetch(`/api/cart/remove/${id}`, { method: 'DELETE' });
                loadCart();
            } catch (e) { console.error(e); }
        }

        loadCategories(); // Start loading
        loadCart();
    </script>
</body>

</html>