<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - Farm Direct</title>
    <link rel="stylesheet" href="css/style.css?v=2">
    <link rel="icon" type="image/png" href="images/brand.png?v=5">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <div id="navbar-container"></div>

    <div class="container">
        <h2>My Orders</h2>

        <div id="orders-list" style="margin-top: 1rem;">
            <!-- Orders loaded here -->
            <p>Loading orders...</p>
        </div>
    </div>

    <!-- Rate Modal -->
    <div id="rateModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div
            style="background: white; padding: 2rem; border-radius: 8px; width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3>Rate Items</h3>
            <p>Select an item to rate:</p>
            <div id="rate-items-list" style="margin-bottom: 2rem; display: flex; flex-direction: column; gap: 0.5rem;">
                <!-- Items injected here -->
            </div>

            <!-- Actual Rating Form (Initially Hidden) -->
            <div id="rating-form" style="display: none; border-top: 1px solid #eee; padding-top: 1rem;">
                <h4 id="rating-product-name">Rate Product</h4>
                <select id="rate_val" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem;">
                    <option value="5">5 Stars - Excellent</option>
                    <option value="4">4 Stars - Good</option>
                    <option value="3">3 Stars - Average</option>
                    <option value="2">2 Stars - Poor</option>
                    <option value="1">1 Star - Terrible</option>
                </select>
                <textarea id="rate_review" placeholder="Write a review..."
                    style="width: 100%; height: 100px; padding: 0.5rem; margin-bottom: 1rem;"></textarea>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="submitRating()" class="btn-primary">Submit Review</button>
                    <button onclick="backToItems()"
                        style="background:none; border:none; cursor:pointer; color: #666;">Back</button>
                </div>
            </div>

            <div style="text-align: right; margin-top: 1rem;">
                <button onclick="closeRateModal()"
                    style="background: #eee; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/nav.js"></script>
    <script>
        let currentFarmerId = null;
        let allOrders = [];

        async function loadOrders() {
            const user = JSON.parse(localStorage.getItem('user'));
            try {
                const res = await fetch(`/api/orders/customer/${user.id}`);
                const orders = await res.json();
                allOrders = orders; // Store globally

                const container = document.getElementById('orders-list');
                if (orders.length === 0) {
                    container.innerHTML = '<p>No orders yet.</p>';
                    return;
                }

                // Note: Since API returns plain orders, I don't easily know who the farmer is directly from the Order entity json without FetchType.EAGER on items or custom DTO
                // However, the backend code for OrderItem uses @ManyToOne to Order.
                // But the Order entity doesn't list items in the JSON unless I added it.
                // I did NOT add `private List<OrderItem> items` in the Order entity (mappedBy...).
                // This means the frontend CANNOT see what's in the order to display products or know which farmer to rate!
                // ERROR: I need to update the Order entity to include `items` or fetch them separately.
                // FIX: I will update the Order entity to have OneToMany items.

                // For now, assuming I fix the backend, here is the code:
                container.innerHTML = orders.map(order => `
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="font-weight: 700;">Order #${order.id}</div>
                            <div class="status-badge status-${order.status}">${order.status}</div>
                            <div class="status-badge status-${order.status}">${order.status.replace(/_/g, ' ')}</div>
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            Date: ${new Date(order.createdAt).toLocaleDateString()}
                        </div>
                        <div style="font-weight: 700; margin-top: 0.5rem; font-size: 1.1rem;">₹${order.totalAmount}</div>
                        
                        ${canCancel(order.status) ?
                        `<button onclick="cancelOrder(${order.id})" style="margin-top:0.5rem; background:none; border:none; color:red; text-decoration:underline; cursor:pointer; font-size:0.9rem;">Cancel Order</button>`
                        : ''}
                        
                        ${order.status === 'DELIVERED' ?
                        `<button onclick="openRateModal(${order.id})" class="btn-primary" style="width: auto; padding: 0.5rem 1rem; font-size: 0.8rem; margin-top: 1rem;">Rate Items</button>` // Changed Text to Rate Items
                        : ''}
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        function canCancel(status) {
            return ['WAITING_FOR_FARMER_APPROVAL', 'FARMER_APPROVED', 'ORDER_PLACED'].includes(status);
        }

        async function cancelOrder(orderId) {
            if (!confirm("Are you sure you want to cancel this order?")) return;

            const user = JSON.parse(localStorage.getItem('user'));
            try {
                const res = await fetch(`/api/orders/cancel/${orderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: user.id })
                });

                if (res.ok) {
                    alert("Order Cancelled");
                    loadOrders();
                } else {
                    const txt = await res.text();
                    alert("Failed to cancel: " + txt);
                }
            } catch (e) { console.error(e); }
        }

        let currentOrderId = null;
        let currentOrderItems = [];
        let selectedProductId = null;

        async function openRateModal(orderId) {
            currentOrderId = orderId;
            document.getElementById('rateModal').style.display = 'flex';
            document.getElementById('rating-form').style.display = 'none';
            document.getElementById('rate-items-list').style.display = 'flex';

            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                document.getElementById('rate-items-list').innerHTML = '<p>Order not found.</p>';
                return;
            }
            if (!order.items || order.items.length === 0) {
                document.getElementById('rate-items-list').innerHTML = '<p>No items found in this order.</p>';
                return;
            }

            const container = document.getElementById('rate-items-list');
            container.innerHTML = order.items.map(item => `
                <div onclick="showRatingForm(${item.product.id}, '${item.product.name.replace(/'/g, "\\'")}')" 
                     style="padding: 1rem; border: 1px solid #eee; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; transition: background 0.2s;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <img src="${item.product.imageUrl || 'https://placehold.co/50'}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover;">
                        <div>
                            <div style="font-weight: 600;">${item.product.name}</div>
                            <div style="font-size: 0.85rem; color: #666;">Qty: ${item.quantity}</div>
                        </div>
                    </div>
                    <div style="color: var(--primary-color);">Rate →</div>
                </div>
            `).join('');
        }

        function closeRateModal() {
            document.getElementById('rateModal').style.display = 'none';
        }

        function showRatingForm(productId, productName) {
            selectedProductId = productId;
            document.getElementById('rating-product-name').innerText = `Rate: ${productName}`;
            document.getElementById('rate-items-list').style.display = 'none';
            document.getElementById('rating-form').style.display = 'block';
            document.getElementById('rate_val').value = '5';
            document.getElementById('rate_review').value = '';
        }

        function backToItems() {
            document.getElementById('rating-form').style.display = 'none';
            document.getElementById('rate-items-list').style.display = 'flex';
        }

        async function submitRating() {
            const user = JSON.parse(localStorage.getItem('user'));
            const rating = document.getElementById('rate_val').value;
            const review = document.getElementById('rate_review').value;

            try {
                const res = await fetch('/api/reviews/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: user.id,
                        orderId: currentOrderId,
                        productId: selectedProductId,
                        rating: parseInt(rating),
                        comment: review
                    })
                });

                if (res.ok) {
                    alert('Review submitted!');
                    backToItems(); // Allow rating other items
                } else {
                    const txt = await res.text();
                    alert('Failed to submit: ' + txt);
                }
            } catch (e) { console.error(e); }
        }

        loadOrders();
    </script>
</body>

</html>